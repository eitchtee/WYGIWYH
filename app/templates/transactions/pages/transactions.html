{% extends 'layouts/base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% translate 'Transactions' %}{% endblock %}

{% block content %}
  <div class="tw:container tw:px-md-3 tw:py-3 tw:column-gap-5">
    <div class="tw:flex tw:flex-wrap tw:gap-x-xl-4 tw:gap-y-3">
      <div class="tw:w-full tw:xl:w-8/12 tw:order-2 tw:xl:order-1">
        <div class="tw:mb-3">
          {# Hidden select to hold the order value and preserve the original update trigger #}
          <select name="order" id="order" class="tw:hidden" _="on change trigger updated on window">
            <option value="default" {% if order == 'default' %}selected{% endif %}>{% translate 'Default' %}</option>
            <option value="older" {% if order == 'older' %}selected{% endif %}>{% translate 'Oldest first' %}</option>
            <option value="newer" {% if order == 'newer' %}selected{% endif %}>{% translate 'Newest first' %}</option>
          </select>

          {# Main control bar with filter, search, and ordering #}
          <div class="tw:join tw:w-full">

            <button class="tw:btn tw:btn-secondary tw:join-item" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-filter"
                    aria-expanded="false" aria-controls="collapse-filter" id="filter-button" hx-preserve
                    title="{% translate 'Filter transactions' %}">
              <i class="fa-solid fa-filter fa-fw"></i>
            </button>

            {# Search box #}
            <label for="quick-search" class="tw:join-item tw:flex-grow">
            </label>
            <input type="search"
                   class="tw:input tw:input-bordered tw:join-item tw:flex-grow"
                   placeholder="{% translate 'Search' %}"
                   hx-preserve
                   id="quick-search"
                   _="on input or search or htmx:afterSwap from window
                         if my value is empty
                           trigger toggle on <.transactions-divider-collapse/>
                         else
                           trigger show on <.transactions-divider-collapse/>
                         end
                         show <.transactions-divider-title/> when my value is empty
                         show <.transaction/> in <#transactions-list/>
                         when its textContent.toLowerCase() contains my value.toLowerCase()">

            {# Order by icon dropdown #}
            <div class="tw:dropdown tw:dropdown-end">
              <button class="tw:btn tw:btn-secondary tw:join-item" type="button"
                      tabindex="0" role="button"
                      title="{% translate 'Order by' %}">
                <i class="fa-solid fa-sort fa-fw"></i>
              </button>
              <ul class="tw:dropdown-content tw:menu tw:bg-base-100 tw:rounded-box tw:z-[1] tw:w-52 tw:p-2 tw:shadow" tabindex="0">
                <li>
                  <button class="{% if order == 'default' %}tw:active{% endif %}" type="button"
                          _="on click remove .tw:active from <button/> in the closest <ul/>
                             then add .tw:active to me
                             then set the value of #order to 'default'
                             then trigger change on #order">
                    {% translate 'Default' %}
                  </button>
                </li>
                <li>
                  <button class="{% if order == 'older' %}tw:active{% endif %}" type="button"
                          _="on click remove .tw:active from <button/> in the closest <ul/>
                             then add .tw:active to me
                             then set the value of #order to 'older'
                             then trigger change on #order">
                    {% translate 'Oldest first' %}
                  </button>
                </li>
                <li>
                  <button class="{% if order == 'newer' %}tw:active{% endif %}" type="button"
                          _="on click remove .tw:active from <button/> in the closest <ul/>
                             then add .tw:active to me
                             then set the value of #order to 'newer'
                             then trigger change on #order">
                    {% translate 'Newest first' %}
                  </button>
                </li>
              </ul>
            </div>
          </div>

          {# Filter transactions form #}
          <div class="tw:collapse" id="collapse-filter" hx-preserve>
            <div class="tw:card tw:card-body tw:bg-base-100 tw:shadow-xl">
              <div class="tw:text-end">
                <button class="tw:btn tw:btn-outline tw:btn-error tw:btn-sm tw:w-fit"
                        _="on click call #filter.reset() then trigger change on #filter">{% translate 'Clear' %}</button>
              </div>

              <form _="on change or submit or search trigger updated on window
                         install init_tom_select
                         install init_datepicker"
                    id="filter" class="tw:mt-3">
                {% crispy filter.form %}
              </form>

              <div class="tw:text-end">
                <button class="tw:btn tw:btn-outline tw:btn-error tw:btn-sm tw:w-fit"
                        _="on click call #filter.reset() then trigger change on #filter">{% translate 'Clear' %}</button>
              </div>
            </div>
          </div>
        </div>
        <div id="transactions"
             class="show-loading"
             hx-get="{% url 'transactions_all_list' %}"
             hx-trigger="load, updated from:window" hx-include="#filter, #page, #order">
        </div>
      </div>
      <div class="tw:w-full tw:xl:w-4/12 tw:order-1 tw:xl:order-2">
        <div role="tablist" class="tw:tabs tw:tabs-lifted">
          <input type="radio" name="all-transactions-summary" role="tab" class="tw:tab" aria-label="{% trans 'Currencies' %}"
                 {% if summary_tab == 'currency' %}checked="checked"{% endif %}
                 _="on change fetch {% url 'transaction_all_summary_select' selected='currency' %}" />
          <div role="tabpanel" class="tw:tab-content tw:bg-base-100 tw:border-base-300 tw:rounded-box tw:p-6">
            <div id="currency-summary"
                 hx-get="{% url 'transaction_all_currency_summary' %}"
                 class="show-loading"
                 hx-trigger="load, selective_update from:window, updated from:window, change from:#filter, submit from:#filter, search from:#filter"
                 hx-include="#filter">
            </div>
          </div>

          <input type="radio" name="all-transactions-summary" role="tab" class="tw:tab" aria-label="{% trans 'Accounts' %}"
                 {% if summary_tab == 'account' %}checked="checked"{% endif %}
                 _="on change fetch {% url 'transaction_all_summary_select' selected='account' %}" />
          <div role="tabpanel" class="tw:tab-content tw:bg-base-100 tw:border-base-300 tw:rounded-box tw:p-6">
            <div id="account-summary"
                 hx-get="{% url 'transaction_all_account_summary' %}"
                 class="show-loading"
                 hx-trigger="load, selective_update from:window, updated from:window, change from:#filter, submit from:#filter, search from:#filter"
                 hx-include="#filter">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <c-ui.transactions_fab></c-ui.transactions_fab>
{% endblock %}
